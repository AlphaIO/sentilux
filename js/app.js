var Util=function(){return{showError:function(e){if($("#error-modal h1").text(e.title||"Whoops!"),e.html)$("#error-modal p").html(e.html);else{var t=e.message||"An unknown error occured.";t.slice(t.length)-1!=="."&&(t+="."),$("#error-modal p").text(t)}$("#error-modal").foundation("open")},hideError:function(){$("#error-modal").foundation("close")}}}();ColorProfiles=function(){function e(e,t,n){return Color(t).mix(Color(e),n)}var t={profile:{name:"moodlight"}},n={moodlight:{settings:{positive:"#00FF00",positiveDisplay:"#3ADB76",negative:"#FF0000",negativeDisplay:"#EC5840"},colorizer:function(t,n){return{light:e(n.negative,n.positive,t).hexString(),display:e(n.negativeDisplay,n.positiveDisplay,t).hexString()}}},calming:{settings:{threshold:.4,"default":"#E5DEC0",defaultDisplay:"#DACE9B",calming:"#48C5B0",calmingDisplay:"#6ACEC1"},colorizer:function(e,t){return e<=t.threshold?{light:t.calming,display:t.calmingDisplay}:{light:t["default"],display:t["default"]}}}};return{config:function(e){$.extend(t,e||{})},colorize:function(e){var o=n[t.profile.name];return o.colorizer(e,t.profile.settings||o.settings)}}}();var LIFX=function(){function e(e,n,r){var i=new Promise(function(i,s){$.ajax({method:e||"GET",dataType:"json",url:o+n,data:r||{},headers:{Authorization:"Bearer "+(r._token||t)}}).done(function(e){i(e)}).fail(function(e,t,n){s(e.responseJSON?e.responseJSON:{err:error})})});return i}var t=Cookies.get("LIFX_TOKEN"),n=!0,o="https://api.lifx.com/v1",r={init:function(o){o||(o=function(){}),t?o():($("#auth-modal").foundation("open"),$("#auth-token-submit").click(function(){var n=$("#auth-token-input").val();n?e("GET","/lights/all",{_token:n}).then(function(e){t=n,Cookies.set("LIFX_TOKEN",t,{path:"",expires:60}),$("#auth-token-error").hide(),$("#auth-token-submit").off("click"),$("#auth-modal").foundation("close"),o()}).then(void 0,function(e){$("#auth-token-error p").text(e.error+"."||"An unknown error occured."),$("#auth-token-error").show()}):($("#auth-token-error p").text("Please enter a token."),$("#auth-token-error").show())}),$("#auth-bypass").click(function(){$("#auth-token-error").hide(),$("#auth-token-submit").off("click"),$("#auth-modal").foundation("close"),n=!1,o()}))},setState:function(t,n){return e("PUT","/lights/"+(t||"all")+"/state",n||{})},live:function(){return n},logout:function(){Cookies.remove("LIFX_TOKEN",{path:""}),location.reload()}};return r}(),Recognizer=function(){var e={};return window.hasOwnProperty("SpeechRecognition")?e.speech=SpeechRecognition:window.hasOwnProperty("webkitSpeechRecognition")&&(e.speech=webkitSpeechRecognition),{compatible:function(){return Boolean(e.speech)},init:function(t){var t=t||{};e.recognizer=new e.speech,e.recognizer.continuous=!0,e.recognizer.interimResults=!0,e.recognizer.onresult=function(e){var n="",o="";$("#interim-transcript").text("");for(var r=e.resultIndex;r<e.results.length;r++){var i=e.results[r];i.isFinal?o=i[0].transcript:n+=i[0].transcript}o?t.handleResult(o):$("#interim-transcript").text(n)}},startListening:function(){e.recognizer.onend=function(){e.recognizer.start()},e.recognizer.start()},stopListening:function(){e.recognizer.onend=void 0,e.recognizer.abort()}}}(),Sentiment=function(){function e(e){return e.reduce(function(e,t){return e+t},0)}var t,n={minBufferSize:1,maxBufferSize:50},o=[],r=/[^\wá-úñäâàéèëêïîöôùüûœç-]/g;return{init:function(e){$.extend(n,e||{}),$.getJSON(n.wordListURL||"wordlists/afinn.json").done(function(e){t=e}).fail(function(e,t,n){Util.showError({message:"We had an error fetching the word list for sentiment analysis."})})},classify:function(e){var n=e.toLowerCase().trim().replace(/\s/g," ").replace(/(\s){2,}/g,"$1").split(" "),o=n.reduce(function(e,n){var o=n.replace(r,""),i=e.prev.replace(r,""),s=t.words[o];if(t.stopwords.indexOf(o)===-1&&"number"==typeof s){var a=t.negators.indexOf(i)!==-1;a&&(n=e.prev+" "+n,o=i+" "+o,s=-s),s=(s+5)/10,e.scores[n]=s,e.sum+=s,e.count++}return{prev:n,scores:e.scores,sum:e.sum,count:e.count}},{prev:"",scores:{},sum:0,count:0}),i={scores:o.scores,mean:o.count>0?o.sum/o.count:void 0};return Sentiment.push(i.mean),i},push:function(t){"number"==typeof t&&(o.unshift(t),o.length>n.bufferSize&&o.pop(),n.onUpdate&&o.length>=n.minBufferSize&&n.onUpdate(e(o)/o.length))},bufferSize:function(){return o.length}}}();Sentiment.init({maxBufferSize:50,onUpdate:function(e){var t=ColorProfiles.colorize(e);$("#overall-sentiment").css("background-color",t.display).text((10*e).toString().slice(0,4)),$("#buffer-size").text(Sentiment.bufferSize().toString()),$("#stats-list").show(),LIFX.live()&&LIFX.setState("all",{power:"on",color:t.light,duration:10}).then(function(e){console.log(e)}).then(void 0,function(e){console.error(e),Util.showError({message:e.error||"An unknown error occurred requesting the LIFX API."})})}}),LIFX.init(function(){$("#logout").click(LIFX.logout),Recognizer.compatible()?(Recognizer.init({handleResult:function(e){function t(e){var t=Object.keys(n.scores),o=new RegExp("("+t.join("|")+")","gi"),r=e.replace(o,function(e){if("number"==typeof n.scores[e]){var t=n.scores[e],o=$("<b>").text(e).prop("title",t.toString()).addClass("scored-token").css("background-color",ColorProfiles.colorize(t).display);return o[0].outerHTML}return e});return r}var n=Sentiment.classify(e);$("#interim-transcript").text(""),$("#last-transcript").text(e),$("#last-transcript").html(t($("#last-transcript").text())),"number"==typeof n.mean?($("#last-score span").css("background-color",ColorProfiles.colorize(n.mean).display).animate({width:100*n.mean+"%"}),$("#last-score span p").text((10*n.mean).toString().slice(0,4)),$("#last-score-container").show()):$("#last-score-container").hide(),$("#last-result").show()}}),$("#toggle-listening").click(function(){"Start Listening"===$(this).text()?(Recognizer.startListening(),$(this).text("Stop Listening").removeClass("success").addClass("alert")):"Stop Listening"===$(this).text()&&(Recognizer.stopListening(),$(this).text("Start Listening").removeClass("alert").addClass("success"))}).removeClass("disabled"),$("#profile-select").change(function(){ColorProfiles.config({profile:{name:this.value}})}),LIFX.live()||$("#tip-callout").show()):Util.showError({html:'Your browser doesn\'t seem to support the Speech Recognition API. Try installing the latest version of <a href="https://www.google.com/chrome">Chrome</a>.'})});